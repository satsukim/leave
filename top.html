<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>HTML Sample</title>
  <style>
    body {
      background-color: beige;
      width: 100%;
      height: 100%;
      touch-action: none;
    }
  </style>
</head>
<body id="parent">
  <iframe id="frame1" name="frame1" src="frame1.html" width="200" height="200" style="border:2px solid blue;">
  </iframe>
  <iframe id="frame2" name="frame2" src="frame2.html" width="200" height="200" style="border:2px solid red;"></iframe>
  <button id="logclearbtn" onclick="clearLog()">clear</button>
  <div id="log" style="width: 500px; height: 300px; border:2px solid green; overflow: auto;">
  </div>
  <script>
  var frames = [];

  function setLeaveEvent(targetWin) {
    targetWin.addEventListener('load', function(e) {
      var targetDoc = e.target;
      var targetWin = targetDoc.defaultView;

      var info = {
        targetWin : targetWin,
        isOn: false
      }
      addEvent(targetWin, targetDoc);
      frames.push(info);
    });
  }
  function addEvent(targetWin, targetDoc) {
    // iOS
    // pointerdownは、要素外からスライドで入ったときは発火しない
    // pointereventは、iOS12ではサポートしていない
    // iOS12以下、IE10以下の場合は、サーバーに固定1を通知

    //frame1とframe2を同時にタップすると、どちらかしか発火しない(排他でうごく)

    //子フレームでcapture=trueでpointerイベントを登録していると、topより先に動作する可能性がある
    //pointerdownはmousedownやtouchstarより先に発火する

    //mouseleaveはpaptureをtrueにすると、別要素にカーソルがいくと発火してしまう
    //mouseleaveはバブリングしないためcaptureはfalseでOK
    //leaveはWindowオブジェではなくDocumentでないと登録できない
    //要素外upは、pointerupを使えばPCの場合は要素外はなしても発火する
    //targetDoc.addEventListener("mouseleave", handlerOff);
    targetWin.addEventListener("pointerdown", handlerOn, true);
    targetWin.addEventListener("pointerup", handlerOff, true);
    //targetWin.addEventListener("pointerleave", handlerOff, true);
    targetWin.addEventListener("pointercancel", handlerOff, true);
    //visibility hiddenもした方がよい

    targetWin.addEventListener("pagehide", function() {
      targetWin.removeEventListener("mouseleave", handlerOff);
      targetWin.removeEventListener("pointerdown", handlerOn);
      targetWin.removeEventListener("pointerup", handlerOff);
    });
  }
  function handlerOn(e) {
    var targetWin = e.currentTarget;
    //var targetWin = targetDoc.defaultView;
    setTargetInfo(targetWin, true);
    showlog(`On: e=` + e.type + ' winName:' + targetWin.name);
  }
  function handlerOff(e) {
    var targetWin = e.currentTarget;
   // var targetWin = targetDoc.defaultView;
   setTargetInfo(targetWin, false);
   showlog(`Off: e=` + e.type + ' winName:' + targetWin.name);
  }
  function showlog (str) {
    var logElem = document.getElementById("log");
    logElem.innerHTML += "<br>" + str;

    // 
    logElem.innerHTML += "<br>";
    frames.forEach((obj, index) => {
      logElem.innerHTML += "Index:" + index + obj.targetWin.name + " isOn:" + obj.isOn + "</br>";
    });

    logElem.scrollTop = logElem.scrollHeight

  }
  function clearLog () {
    var logElem = document.getElementById("log");
    logElem.innerHTML = "log";
  }
  function getTargetInfoList(targetWin) {
    var targetInfoList = frames.filter(function (info) {
      //console.log(info.targetWin.name);
      return (info.targetWin === targetWin);
    });
    return targetInfoList;
  }

  function setTargetInfo(targetWin, isOn) {
    var targetInfoList = getTargetInfoList(targetWin);
    targetInfoList.forEach(function (info) {
      info.isOn = isOn;
    });
  }

  document.addEventListener("mouseleave", () => {
    showlog("カーソルがウィンドウ全体から離れました");
  });
  </script>
</body>
</html>